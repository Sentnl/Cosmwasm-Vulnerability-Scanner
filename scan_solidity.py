import os
import openai
import fnmatch

def find_solidity_files(path):
    solidity_files = []

    for root, _, filenames in os.walk(path):
        for filename in fnmatch.filter(filenames, '*.sol'):
            solidity_files.append(os.path.join(root, filename))

    return solidity_files

def scan_solidity_file(file_path, api_key):
    # Connect to the OpenAI API
    openai.api_key = api_key

    # Read the Solidity file content
    with open(file_path) as f:
        solidity_code = f.read()

    # Make a request to the OpenAI API to analyze the Solidity file
    result = openai.Completion.create(engine="text-davinci-002", prompt=f"Analyze vulnerabilities in the following Solidity code:\n{solidity_code}\n\nVulnerabilities:", max_tokens=100, n=1, stop=None, temperature=0.5)

    return result.choices[0].text.strip()

def main():
    api_key = os.environ['INPUT_OPENAI_API_KEY']
    engine = os.environ['INPUT_ENGINE']
    repo_path = os.getcwd()
    solidity_files = find_solidity_files(repo_path)

    for file in solidity_files:
        print(f"Scanning {file}...")
        vulnerabilities = scan_solidity_file(file, api_key, engine)
        with open(f"{file}_vulnerabilities.txt", "w") as f:
            f.write(f"Vulnerabilities found in {file}:\n{vulnerabilities}\n")

if __name__ == "__main__":
    main()
